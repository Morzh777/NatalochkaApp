events {}

http {
    charset utf-8;

    # üîí –õ–∏–º–∏—Ç 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ IP
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;

    upstream calculate_service {
        server numerology-api:3001;
    }

    upstream db_service {
        server db-api:3003;
    }

    upstream description_service {
        server description-api:3002;
    }

    upstream gateway_service {
        server gateway-api:3005;
    }

    # üìç –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø—É—Ç–µ–π –∫ —Å–µ—Ä–≤–∏—Å–∞–º
map $request_uri $api_upstream {
    default "";

    # ==============================
    # üìä –†–∞—Å—á—ë—Ç—ã
    # ==============================
    ~^/api/calculate$                             gateway_service;
    ~^/api/calculate-json$                        calculate_service;
    ~^/api/calculate-matrix$                      calculate_service;

    # ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (—Ä–∞—Å—á—ë—Ç + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
    ~^/api/matrix/compatibility/calculate$        calculate_service;
    ~^/api/matrix/compatibility/save$             db_service;

    # ==============================
    # üß† –û–ø–∏—Å–∞–Ω–∏—è
    # ==============================
    ~^/api/description/destiny/[^/]+$             gateway_service;
    ~^/api/description$                           description_service;
    ~^/api/description/program/[^/?]+(\?.*)?$     gateway_service;
    ~^/api/description/land/[^/]+$                gateway_service;
    ~^/api/description/sky/[^/]+$                 gateway_service;
    ~^/api/description/dest/[^/]+$                gateway_service;
    ~^/api/description/partner/[^/]+$             gateway_service;
    ~^/api/description/relation/[^/]+$            gateway_service;
    ~^/api/description/money/[^/]+$               gateway_service;
    ~^/api/description/work/[^/]+$                gateway_service;
    ~^/api/description/atmCouple/[^/]+$           gateway_service;
    ~^/api/description/appearance/[^/]+$          gateway_service;
    ~^/api/description/positiveMeaning/[^/]+$     gateway_service;
    ~^/api/description/materialMeaning/[^/]+$     gateway_service;
    ~^/api/description/coupleTask/[^/]+$          gateway_service;
    ~^/api/description/attraction/[^/]+$          gateway_service;
    ~^/api/description/cache/[^/]+$               gateway_service;
    ~^/api/description/cacheTrouble/[^/]+$        gateway_service;
    # ==============================
    # üî• –ü–∞–∫–µ—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
    # ==============================
    ~^/api/compatibility/batch$                   gateway_service;
    ~^/api/compatibility(\?.*)?$                  description_service;
    ~^/api/compatibility/history.*$               gateway_service;

    # ==============================
    # üí∞ –ü–æ–¥–ø–∏—Å–∫–∏ –∏ –æ–ø–ª–∞—Ç—ã
    # ==============================
    ~^/api/premium/save-payment$                  db_service;
    ~^/api/premium/[^/]+(\?.*)?$                  gateway_service;
    ~^/api/premium/[^/]+/redeem$                  gateway_service;
    # ==============================
    # üß¨ –ú–∞—Ç—Ä–∏—Ü—ã —Å—É–¥—å–±—ã (–∏—Å—Ç–æ—Ä–∏—è)
    # ==============================
    ~^/api/matrix_history/paginated(\?.*)?$       gateway_service;
    ~^/api/matrix_history/?$                      gateway_service;

    # üîÅ –ú–∞—Ç—Ä–∏—Ü—ã —Å—É–¥—å–±—ã (–∑–∞–ø—Ä–æ—Å—ã –∏ —Ä–∞—Å—á—ë—Ç—ã)
    ~^/api/matrix/by-date(\?.*)?$                 db_service;
    ~^/api/matrix/destiny$                        gateway_service;
    ~^/api/matrix(\?.*)?$                         db_service;
    ~^/api/matrix$                                db_service;
    ~^/api/matrix/.*$                             db_service;

    # ==============================
    # üß± –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏ –æ–±—â–∏–µ
    # ==============================
    ~^/api/history/paginated$                     gateway_service;
    ~^/api/users/active$                          gateway_service;
    ~^/api/users/[^/]+/compatibility.*$           db_service;
    ~^/api/users/[^/]+/history/paginated.*$       db_service;
    ~^/api/calculation(\?.*)?$                    db_service;
    ~^/api/calculation$                           db_service;
    ~^/api/calculation/.*$                        db_service;
    ~^/api/(user|users|stats|history)             db_service;
}

    server {
        listen 80;

        location ~ ^/api/ {
            # üö® Rate Limiting
            limit_req zone=api_limit burst=25 nodelay;

            # üì° –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –Ω—É–∂–Ω–æ–º—É –∞–ø—Å—Ç—Ä–∏–º—É
            proxy_pass http://$api_upstream;

            # üì¶ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–æ–∫—Å–∏
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # ‚öôÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞ keep-alive
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        location = / {
            default_type text/plain;
            add_header Content-Type "text/plain; charset=utf-8";
            return 200 "‚úÖ Nginx API Gateway —Ä–∞–±–æ—Ç–∞–µ—Ç\n";
        }
    }
}
