# DB API

Микросервис для управления пользователями, историей расчетов, матрицами и премиум-доступом. Используется как часть архитектуры Telegram-бота, но может применяться и отдельно для хранения и получения данных.

## Основные возможности

- Регистрация и управление пользователями
- Хранение и получение истории расчетов
- Работа с матрицами и их историей
- Управление премиум-доступом и оплатами
- Пагинация истории, фильтрация по дате
- Совместимость пользователей и матриц
- Готов к интеграции с внешними сервисами и ботами

## Шифрование пользовательских данных

- **Имя** и **дата рождения** пользователя хранятся в базе данных в зашифрованном виде (алгоритм AES-256-CBC).
- Для шифрования используется ключ из переменной окружения `SECRET_KEY`.
- Дешифровка происходит автоматически при чтении данных через API.
- Это обеспечивает дополнительную защиту персональных данных пользователей.

## Технологический стек

- **Node.js 20+** — серверная платформа
- **TypeScript** — типизированный JavaScript
- **Express** — веб-фреймворк для API
- **SQLite** — встроенная база данных
- **date-fns** — работа с датами
- **zod** — валидация данных
- **Docker** — контейнеризация и деплой
- **dotenv** — управление переменными окружения
- **Node.js crypto + AES-256-CBC** — шифрование и дешифрование пользовательских данных (имя, дата рождения)
- **Base64** — кодирование зашифрованных данных для хранения
- **SECRET_KEY** — переменная окружения для ключа шифрования

## Структура проекта

- `src/controllers/` — контроллеры (логика API: пользователи, премиум)
- `src/services/` — бизнес-логика, работа с БД
- `src/db/` — инициализация и утилиты для работы с базой данных
- `src/utils/` — вспомогательные функции
- `src/validation/` — схемы валидации данных
- `src/data/` — статические данные

## Быстрый старт (локально)

1. **Установите Node.js 20+ и npm**
2. **Установите зависимости:**
   ```bash
   npm ci
   ```
3. **Соберите проект:**
   ```bash
   npm run build
   ```
4. **Запустите сервер:**
   ```bash
   npm start
   ```
   По умолчанию сервис стартует на порту 3003.

5. **Для разработки:**
   ```bash
   npm run dev
   ```

## Переменные окружения

Создайте файл `.env` в корне и укажите:
```
PORT=3003
SECRET_KEY=your_secret_key
```
(и другие переменные по необходимости)

## Основные эндпоинты

Все маршруты начинаются с `/api`:

- **Пользователи**
  - `POST /api/user` — регистрация пользователя
  - `GET /api/users/active` — список активных пользователей
  - `GET /api/users/:id` — профиль пользователя
  - `DELETE /api/users/:id` — удалить пользователя

- **История расчетов**
  - `GET /api/users/:id/history` — вся история пользователя
  - `GET /api/users/:id/history/by-date` — история по дате
  - `POST /api/user_history` — добавить запись в историю
  - `GET /api/users/:id/history/paginated` — история с пагинацией

- **Расчёты**
  - `POST /api/calculation` — сохранить расчет
  - `GET /api/calculation` — получить расчет по дате
  - `GET /api/calculation/:id` — получить расчет по id

- **Матрицы**
  - `POST /api/matrix` — сохранить матрицу
  - `GET /api/matrix` — получить матрицу
  - `POST /api/matrix_history` — сохранить историю матриц
  - `GET /api/matrix_history/paginated` — история матриц с пагинацией
  - `GET /api/matrix/by-date` — получить матрицу по дате

- **Совместимость**
  - `GET /api/users/:id/compatibility` — история совместимости пользователя
  - `GET /api/matrix/compatibility/by-date` — совместимость по дате
  - `POST /api/matrix/compatibility/save` — сохранить совместимость матриц

- **Премиум**
  - `GET /api/premium/:userId` — статус премиум-доступа
  - `POST /api/premium/save-payment` — сохранить оплату
  - `POST /api/premium/:userId/redeem` — активировать премиум-код

## Зависимости

### Основные

- `express`, `cors` — веб-сервер и поддержка CORS
- `sqlite`, `sqlite3` — база данных SQLite
- `date-fns` — работа с датами
- `zod` — валидация данных
- `dotenv` — переменные окружения

### Для разработки

- `typescript`, `ts-node-dev` — поддержка TypeScript и hot-reload
- `@types/*` — типы для TypeScript

## Сборка и запуск в Docker

1. Соберите и запустите контейнер:
   ```bash
   docker build -t db-api .
   docker run --env-file .env -p 3003:3003 db-api
   ```

## Скрипты npm

- `npm run dev` — запуск в режиме разработки
- `npm run build` — сборка проекта
- `npm start` — запуск собранного сервера

## Контакты

by Morzh  
@: kla_atu@mail.ru

--- 