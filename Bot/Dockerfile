# ===== 1. Ğ¡Ğ¢ĞĞ”Ğ˜Ğ¯ Ğ¡Ğ‘ĞĞ ĞšĞ˜ =====
FROM node:20 AS builder

WORKDIR /app

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ canvas
RUN echo "deb http://ftp.de.debian.org/debian bookworm main" > /etc/apt/sources.list && \
    echo "deb http://ftp.de.debian.org/debian-security bookworm-security main" >> /etc/apt/sources.list && \
    apt-get update && apt-get install -y \
    libcairo2-dev \
    libjpeg-dev \
    libpango1.0-dev \
    libgif-dev \
    libx11-dev \
    pkg-config \
    build-essential \
    fonts-dejavu-core \
    fontconfig \
    fonts-liberation \
 && rm -rf /var/lib/apt/lists/*

COPY package*.json ./
RUN npm ci

# Ğ¯Ğ²Ğ½Ğ¾ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ”Ğ npm run build
COPY ./src/style/img ./style/img
COPY . .

RUN npm run build

# ===== 2. Ğ¡Ğ¢ĞĞ”Ğ˜Ğ¯ ĞŸĞ ĞĞ”ĞĞšĞ¨Ğ•Ğ =====
FROM node:20-slim

WORKDIR /app

# Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ runtime Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ canvas
RUN echo "deb http://ftp.de.debian.org/debian bookworm main" > /etc/apt/sources.list && \
    echo "deb http://ftp.de.debian.org/debian-security bookworm-security main" >> /etc/apt/sources.list && \
    apt-get update && apt-get install -y \
    libcairo2 \
    libjpeg62-turbo \
    libpango-1.0-0 \
    libgif7 \
    libx11-6 \
    fonts-dejavu-core \
    fontconfig \
    fonts-liberation \
 && rm -rf /var/lib/apt/lists/*

RUN fc-cache -f -v

# ğŸ‘‡ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
COPY --from=builder /app/style/img ./style/img

# ğŸ‘‡ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./

# ğŸš€ Ğ·Ğ°Ğ¿ÑƒÑĞº
CMD ["node", "dist/index.js"]
